"use client";

import { useState, useEffect } from "react";
import { CheckCircle2 } from "lucide-react";
import { TripForm } from "@/components/delegate/trip-form";
import { TodayTrips } from "@/components/delegate/today-trips";
import { District, RouteEntity, TripEntry } from "@/components/delegate/types";

interface DelegateClientProps {
    initialRoutes: RouteEntity[];
    initialDistricts: District[];
    initialTrips: TripEntry[];
}

export default function DelegateClient({
    initialRoutes,
    initialDistricts,
    initialTrips,
}: DelegateClientProps) {
    const [routes] = useState<RouteEntity[]>(initialRoutes);
    const [districts] = useState<District[]>(initialDistricts);
    const [trips, setTrips] = useState<TripEntry[]>(initialTrips);
    const [tripsLoading, setTripsLoading] = useState(false);
    const [loading, setLoading] = useState(false);

    const [success, setSuccess] = useState(false);

    // We still need this to refresh trips after submission
    const fetchTodayTrips = async () => {
        try {
            setTripsLoading(true);
            const today = new Date().toISOString().split("T")[0];
            const res = await fetch(`/Performance/api/trips?date=${today}`);
            const data = await res.json();
            setTrips(Array.isArray(data) ? data : []);
        } catch (error) {
            console.error("Error fetching trips:", error);
        } finally {
            setTripsLoading(false);
        }
    };

    const handleTripSubmit = async (data: any) => {
        setLoading(true);
        setSuccess(false);

        try {
            // Find the selected route to get busId
            const selectedRoute = routes.find(r => r.id === data.routeId);
            if (!selectedRoute || !selectedRoute.bus?.id) {
                alert("خطأ: الرحلة المحددة ليس لديها باص");
                return;
            }

            // Convert time string like "7:00 AM" to 24-hour format
            const convertTo24Hour = (timeStr: string): string => {
                const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
                if (!match) return "12:00";

                let [, hourStr, minute, period] = match;
                let hour = parseInt(hourStr);

                if (period.toUpperCase() === 'PM' && hour !== 12) {
                    hour += 12;
                } else if (period.toUpperCase() === 'AM' && hour === 12) {
                    hour = 0;
                }

                return `${hour.toString().padStart(2, '0')}:${minute}`;
            };

            const res = await fetch("/Performance/api/trips", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    routeId: selectedRoute.id, // Use routeId as per new schema
                    busId: selectedRoute.bus.id,
                    tripDate: new Date(data.tripDate).toISOString(),
                    direction: data.direction,
                    scheduledTime: convertTo24Hour(data.tripTime),
                    passengersCount: data.studentsCount,
                    status: data.status,
                    notes: data.notes,
                }),
            });

            if (res.ok) {
                setSuccess(true);
                fetchTodayTrips();
                setTimeout(() => setSuccess(false), 3000);
            } else {
                const error = await res.json();
                alert(error.error || "حدث خطأ");
            }
        } catch (error) {
            console.error("Error creating trip:", error);
            alert("حدث خطأ في تسجيل الرحلة");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div
            className="min-h-screen bg-slate-50"
            dir="rtl"
            suppressHydrationWarning
        >
            <div className="max-w-6xl mx-auto px-4 md:px-8 py-8">
                {/* Success Message */}
                {success && (
                    <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3 animate-in fade-in slide-in-from-top-2">
                        <CheckCircle2 className="w-6 h-6 text-green-600" />
                        <p className="text-green-700 font-medium">تم تسجيل الرحلة بنجاح!</p>
                    </div>
                )}

                <div className="grid lg:grid-cols-1 gap-8">
                    <TripForm
                        routes={routes}
                        onSubmit={handleTripSubmit}
                        loading={loading}
                    />

                    <TodayTrips
                        trips={trips}
                        loading={tripsLoading}
                        onRefresh={fetchTodayTrips}
                    />
                </div>
            </div>
        </div>
    );
}

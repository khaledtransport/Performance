'use client'

import { useState, useMemo, useEffect } from 'react'
import Calendar from 'react-calendar'
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { ArrowLeft, RefreshCcw, Calendar as CalendarIcon } from 'lucide-react'
import Link from 'next/link'
import { useTripsRange } from '@/lib/hooks/useTripsRange'

type View = 'month' | 'week' | 'day'

function startOfWeek(date: Date) {
  const d = new Date(date)
  const day = d.getDay()
  d.setDate(d.getDate() - day)
  d.setHours(0,0,0,0)
  return d
}

function endOfWeek(date: Date) {
  const s = startOfWeek(date)
  const e = new Date(s)
  e.setDate(s.getDate() + 6)
  e.setHours(23,59,59,999)
  return e
}

function formatArabicDate(date: Date) {
  return new Intl.DateTimeFormat('ar-SA-u-ca-gregory', {
    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
  }).format(date)
}

export default function TripsCalendarPage() {
  const [activeDate, setActiveDate] = useState<Date>(new Date())
  const [view, setView] = useState<View>('month')
  const [forceRefreshKey, setForceRefreshKey] = useState(0)
  const [mounted, setMounted] = useState(false)
  useEffect(() => { setMounted(true) }, [])

  const { startDate, endDate } = useMemo(() => {
    if (view === 'day') {
      const s = new Date(activeDate); s.setHours(0,0,0,0)
      const e = new Date(activeDate); e.setHours(23,59,59,999)
      return { startDate: s.toISOString(), endDate: e.toISOString() }
    }
    if (view === 'week') {
      const s = startOfWeek(activeDate)
      const e = endOfWeek(activeDate)
      return { startDate: s.toISOString(), endDate: e.toISOString() }
    }
    const first = new Date(activeDate.getFullYear(), activeDate.getMonth(), 1)
    const last = new Date(activeDate.getFullYear(), activeDate.getMonth() + 1, 0)
    first.setHours(0,0,0,0); last.setHours(23,59,59,999)
    return { startDate: first.toISOString(), endDate: last.toISOString() }
  }, [activeDate, view, forceRefreshKey])

  const { dailySummary, isLoading, isError, refresh } = useTripsRange({ startDate, endDate })
  const gregDate = useMemo(() => formatArabicDate(activeDate), [activeDate])

  const summaryMap = useMemo(() => {
    const map: Record<string, { count: number; arrived?: number; delayed?: number; pending?: number }> = {}
    for (const d of dailySummary) {
      const k = d.date
      map[k] = {
        count: d.trips.length,
        arrived: d.statusCounts['ARRIVED'] || 0,
        delayed: d.statusCounts['DELAYED'] || 0,
        pending: d.statusCounts['PENDING'] || 0
      }
    }
    return map
  }, [dailySummary])

  const tileContent = ({ date }: { date: Date }) => {
    if (!mounted) return null
    const key = date.toISOString().split('T')[0]
    const data = summaryMap[key]
    if (!data) return null
    return (
      <div className="flex items-start justify-end w-full h-full p-1 pointer-events-none">
        <span className="w-2 h-2 rounded-full bg-indigo-500 shadow" />
      </div>
    )
  }

  const selectedDayTrips = dailySummary.find(d => d.date === activeDate.toISOString().split('T')[0])

  // جدول كامل 12 ساعة صباحاً ومساءً
  const morningTimes = ['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00']
  const eveningTimes = ['18:00','19:00','20:00','21:00','22:00','23:00','00:00','01:00','02:00','03:00','04:00','05:00']

  const driversForDay = useMemo(() => {
    if (!selectedDayTrips) return []
    const map: Record<string, any> = {}
    for (const trip of selectedDayTrips.trips) {
      const d = trip.route?.driver
      if (d && !map[d.id]) map[d.id] = d
    }
    return Object.values(map)
  }, [selectedDayTrips])

  const tripCellMap = useMemo(() => {
    const cell: Record<string, any[]> = {}
    if (selectedDayTrips) {
      for (const trip of selectedDayTrips.trips) {
        const driverId = trip.route?.driver?.id || 'unknown'
        const key = driverId + '|' + trip.tripTime
        if (!cell[key]) cell[key] = []
        cell[key].push(trip)
      }
    }
    return cell
  }, [selectedDayTrips])

  const renderTripSquare = (list: any[]) => {
    if (!list || !list.length) return null
    const t = list[0]
    const students = list.reduce((s, x) => s + (x.studentsCount||0), 0)
    const uni = t.route?.university?.name || ''
    const statusColor: Record<string,string> = {
      ARRIVED: 'bg-green-100 border-green-300',
      DEPARTED: 'bg-blue-100 border-blue-300',
      DELAYED: 'bg-orange-100 border-orange-300',
      PENDING: 'bg-yellow-100 border-yellow-300',
      CANCELLED: 'bg-red-100 border-red-300'
    }
    return (
      <div className={`h-full w-full rounded-md border text-[10px] p-1 flex flex-col justify-center items-center leading-tight ${statusColor[t.status]||'bg-gray-100 border-gray-300'}`}> 
        <div className="font-semibold truncate w-full text-center" title={uni}>{students} طالب</div>
        <div className="truncate w-full text-center" title={uni}>{uni}</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-white">
      <div className="border-b bg-gray-50">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-3 bg-indigo-500 rounded-lg">
              <CalendarIcon className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-2xl font-bold">التقويم التفاعلي للرحلات</h1>
              <p className="text-sm text-gray-600">عرض يومي / أسبوعي / شهري للرحلات</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Link href="/dashboard">
              <Button variant="outline">عودة</Button>
            </Link>
          </div>
        </div>
      </div>

      <div className="px-3 py-4 space-y-4 w-full max-w-full">
        <Card>
          <CardHeader className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pb-2">
            <div>
              <CardTitle>التقويم</CardTitle>
              <CardDescription suppressHydrationWarning>{mounted ? gregDate : '—'}</CardDescription>
            </div>
            <div className="flex flex-wrap gap-1">
              <Button variant={view==='day'?'default':'outline'} size="sm" onClick={() => setView('day')}>يوم</Button>
              <Button variant={view==='week'?'default':'outline'} size="sm" onClick={() => setView('week')}>أسبوع</Button>
              <Button variant={view==='month'?'default':'outline'} size="sm" onClick={() => setView('month')}>شهر</Button>
              <Button variant="outline" size="sm" onClick={() => { refresh(); setForceRefreshKey(v=>v+1) }} disabled={isLoading}>
                <RefreshCcw className={`w-4 h-4 ml-1 ${isLoading ? 'animate-spin' : ''}`} /> تحديث
              </Button>
            </div>
          </CardHeader>
          <CardContent className="p-3 lg:p-4">
            <div className="flex flex-col gap-4 w-full">
              <div className="w-full order-1">
                <Card className="bg-gray-50 border rounded-md shadow-sm">
                  <CardHeader className="pb-1">
                    <CardTitle className="text-sm">رحلات اليوم المحدد</CardTitle>
                    <CardDescription suppressHydrationWarning>{mounted ? gregDate : '—'}</CardDescription>
                  </CardHeader>
                  <CardContent className="pt-1">
                    {isLoading ? (
                      <p className="text-gray-500 text-xs">جاري التحميل...</p>
                    ) : isError ? (
                      <p className="text-red-600 text-xs">تعذر جلب البيانات</p>
                    ) : selectedDayTrips && selectedDayTrips.trips.length ? (
                      <div className="space-y-4">
                        <div className="space-y-1">
                          <h3 className="text-xs font-semibold text-gray-700">الشبكة (صباحاً 6:00 - 17:00)</h3>
                          <div className="overflow-x-auto rounded-md border">
                            <table className="min-w-max text-[10px] align-middle">
                              <thead>
                                <tr className="bg-gray-100">
                                  <th className="border px-1 py-0.5 w-24 sticky right-0 bg-gray-100 z-10">السائق</th>
                                  {morningTimes.map(t => (
                                    <th key={t} className="border px-1 py-0.5 text-center min-w-[60px]">{t}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {driversForDay.map(d => (
                                  <tr key={d.id} className="bg-white hover:bg-gray-50">
                                    <td className="border px-1 py-0.5 font-medium truncate sticky right-0 bg-white z-10" title={d.name}>{d.name}</td>
                                    {morningTimes.map(t => (
                                      <td key={d.id + t} className="border p-0 h-12 w-[60px] align-middle">
                                        {renderTripSquare(tripCellMap[d.id + '|' + t])}
                                      </td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div className="space-y-1">
                          <h3 className="text-xs font-semibold text-gray-700">الشبكة (مساءً 18:00 - 05:00)</h3>
                          <div className="overflow-x-auto rounded-md border">
                            <table className="min-w-max text-[10px] align-middle">
                              <thead>
                                <tr className="bg-gray-100">
                                  <th className="border px-1 py-0.5 w-24 sticky right-0 bg-gray-100 z-10">السائق</th>
                                  {eveningTimes.map(t => (
                                    <th key={t} className="border px-1 py-0.5 text-center min-w-[60px]">{t}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {driversForDay.map(d => (
                                  <tr key={d.id} className="bg-white hover:bg-gray-50">
                                    <td className="border px-1 py-0.5 font-medium truncate sticky right-0 bg-white z-10" title={d.name}>{d.name}</td>
                                    {eveningTimes.map(t => (
                                      <td key={d.id + t} className="border p-0 h-12 w-[60px] align-middle">
                                        {renderTripSquare(tripCellMap[d.id + '|' + t])}
                                      </td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div className="space-y-1">
                          <h3 className="text-xs font-semibold text-gray-700">قائمة الرحلات</h3>
                          <div className="grid gap-1.5 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                            {selectedDayTrips.trips.map(trip => (
                              <div key={trip.id} className="border rounded p-1.5 bg-white flex flex-col gap-0.5 text-[10px] shadow-sm">
                                <div className="flex justify-between">
                                  <span className="font-semibold">{trip.tripTime}</span>
                                  <span className="text-gray-600">{trip.direction === 'GO' ? 'ذهاب' : 'عودة'}</span>
                                </div>
                                <span>السائق: {trip.route?.driver?.name}</span>
                                <span>جامعة: {trip.route?.university?.name}</span>
                                <span>طلاب: {trip.studentsCount}</span>
                                <span className="text-xs text-gray-500">الحالة: {trip.status}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    ) : (
                      <p className="text-gray-500">لا توجد رحلات في هذا اليوم</p>
                    )}
                  </CardContent>
                </Card>
              </div>
              <div className="w-full order-2">
                <div className="rounded-lg border shadow-sm bg-white p-2 w-full min-h-[360px]">
                  {mounted ? (
                    <Calendar
                      locale="ar-SA"
                      onClickDay={(d) => setActiveDate(d)}
                      onActiveStartDateChange={({ activeStartDate }) => activeStartDate && setActiveDate(activeStartDate)}
                      value={activeDate}
                      className="react-calendar w-full min-h-[320px] text-xs [&_.react-calendar__tile]:h-12 [&_.react-calendar__tile]:text-[10px]"
                      tileContent={tileContent as any}
                    />
                  ) : (
                    <div className="w-full h-[320px] animate-pulse grid grid-cols-7 gap-1">
                      {Array.from({ length: 42 }).map((_, i) => (
                        <div key={i} className="bg-gray-100 rounded" />
                      )}
                    </div>
                  )}
                  <div className="mt-2 flex flex-wrap gap-2 text-[10px]">
                    <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 bg-indigo-500 rounded-full" /> يوم يحتوي رحلات</span>
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}